//var pgn = '[Event "Bled-Zagreb-Belgrade Candidates"] \n\
//[Site "Bled, Zagreb & Belgrade YUG"] \n\
//[Date "1959.09.11"] \n\
//[EventDate "1959.09.07"] \n\
//[Round "4"] \n\
//[Result "1-0"] \n\
//[White "Robert James Fischer"] \n\
//[Black "Svetozar Gligoric"] \n\
//[ECO "B57"] \n\
//[WhiteElo "?"] \n\
//[BlackElo "?"] \n\
//[PlyCount "63"] \n\
//\n\
//1. e4 c5 2. Nf3 Nc6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 d6 6. Bc4 \n\
//Bd7 7. Bb3 g6 8. f3 Na5 9. Bg5 Bg7 10. Qd2 h6 11. Be3 Rc8 \n\
//12. O-O-O Nc4 13. Qe2 Nxe3 14. Qxe3 O-O 15. g4 Qa5 16. h4 e6 \n\
//17. Nde2 Rc6 18. g5 hxg5 19. hxg5 Nh5 20. f4 Rfc8 21. Kb1 Qb6 \n\
//22. Qf3 Rc5 23. Qd3 Bxc3 24. Nxc3 Nxf4 25. Qf3 Nh5 26. Rxh5 \n\
//gxh5 27. Qxh5 Be8 28. Qh6 Rxc3 29. bxc3 Rxc3 30. g6 fxg6 \n\
//31. Rh1 Qd4 32. Qh7+ 1-0';
	
//var pgn = '[Event "1er Festival Comtois"] \n\
//[Site "Besancon"] \n\
//[Round "8"] \n\
//[Date "1998.7.11"] \n\
//[White "Legky, Nikolay A"] \n\
//[Black "Loeffler, Markus"] \n\
//[Result "0-1"] \n\
//\n\
//1.d4 Nf6 2.c4 g6 3.Nc3 d5 4.Nf3 Bg7 5.Qb3 dxc4 6.Qxc4 O-O 7.Bf4 c6 8.e4 a5 9.Be2 a4 10.a3 Nbd7 11.O-O Qa5 12.Rac1 Nxe4 13.Nxe4 Qf5 14.Bg5 Qxe4 15.Bd3 Qg4 16.Bxe7 Re8 17.Rfe1 Nb6 18.Qc2 Be6 19.Re4 Qh5 20.Bc5 Bb3 21.Qe2 Rxe4 22.Qxe4 Nd7 23.Bd6 Bd5 24.Qe3 Bxf3 25.Qxf3 Qxf3 26.gxf3 Bxd4 27.Re1 Nf6 28.Re2 Rd8 29.Bb4 Nd5 30.Bc4 b5 31.Bxd5 Rxd5 32.Re8+ Kg7 33.Bf8+ Kf6 34.Rc8 c5 35.Rb8 c4 36.Kf1 Bxb2 37.Bb4 h5 38.Rb7 Bd4 39.Ke2 Re5+ 40.Kd2 Bxf2 41.f4 Rd5+ 42.Ke2 Bd4 43.Kf3 Bb2 44.Bf8 g5 45.Be7+ Ke6 46.fxg5 c3 47.Bf6 Rf5+ 48.Ke4 Rxf6 49.Rb6+ Kd7 0-1';

//var pgn = '[Event "Cannes op"] \n\
//[Site "Cannes op"] \n\
//[Round "8"] \n\
//[Date "1995.??.??"] \n\
//[White "Loeffler, Markus"] \n\
//[Black "Tratar, Marko"] \n\
//[Result "1-0"] \n\
//	 \n\
//1.e4 b6 2.d4 Bb7 3.Bd3 e6 4.Nf3 c5 5.Qe2 cxd4 6.Nxd4 Nc6 7.Nxc6 Bxc6 8.Nc3 Nf6 9.e5 Nd5 10.Ne4 Qb8 11.f4 Nb4 12.O-O Be7 13.Bd2 Nxd3 14.cxd3 Qb7 15.f5 O-O-O 16.Bg5 Bxe4 17.Bxe7 Rde8 18.dxe4 Rxe7 19.Rac1+ Kb8 20.Qd3 1-0';

//var pgn = '[Event "OLBaden 9293"] \n\
//[Site "OLBaden 9293"] \n\
//[Round "73"] \n\
//[Date "1993.??.??"] \n\
//[White "Loeffler, Markus"] \n\
//[Black "Kargoll, Boris"] \n\
//[Result "1-0"] \n\
//	 \n\
//1.e4 c5 2.Nf3 d6 3.d4 cxd4 4.Nxd4 Nf6 5.Nc3 a6 6.Bc4 e6 7.Bb3 b5 8.O-O Be7 9.Qf3 Qb6 10.Be3 Qb7 11.Qg3 O-O 12.Bh6 Ne8 13.Rfe1 Kh8 14.Bg5 b4 15.Nce2 Bxg5 16.Qxg5 Qxe4 17.Rad1 Qb7 18.Rd3 Nc6 19.Nxc6 Qxc6 20.Qe7 Kg8 21.Nf4 Qc5 22.Ba4 Ra7 23.Qd8 Qc7 24.Qg5 Bd7 25.Bb3 a5 26.c3 Qc5 27.Qh4 bxc3 28.Rxc3 Qd4 29.Rd1 Qf6 30.Qg3 h6 31.h4 g6 32.Bc2 d5 33.Nd3 Ng7 34.Ne5 Nf5 35.Bxf5 Qxf5 36.Rf3 Qc2 37.Re1 Be8 38.h5 Qd2 39.Rfe3 g5 40.Ng4 Kh7 41.Nf6+ 1-0';

var pgn = '[Event "Open"] \n\
[Site "Cannes FRA"] \n\
[Round "2"] \n\
[Date "2000.2.21"] \n\
[White "Loeffler, Markus"] \n\
[Black "Dichev, Nedelcho"] \n\
[Result "1-0"] \n\
\n\
1.e4 c6 2.d4 d5 3.Nc3 dxe4 4.Nxe4 Nf6 5.Nxf6+ exf6 6.c3 Bd6 7.Bd3 O-O 8.Ne2 Re8 9.O-O Qc7 10.Ng3 Nd7 11.Nf5 Bxh2+ 12.Kh1 Bd6 13.Nxg7 Kxg7 14.Qg4+ Kh8 15.Bh6 Rg8 16.Qh4 Rg6 17.Rae1 Qd8 18.Bxg6 fxg6 19.Re6 Be7 20.Rfe1 Ne5 21.Rxe7 Qxe7 22.dxe5 g5 23.Qd4 Bf5 24.Re3 c5 25.exf6 Qf7 26.Qe5 Bg6 27.Bxg5 b6 28.a4 Re8 29.Qd6 Rxe3 30.Bxe3 h5 31.a5 c4 32.axb6 axb6 33.Bxb6 Kh7 34.Bd4 Bf5 35.Qf4 Be6 36.Qe4+ Kg8 37.Qa8+ Kh7 38.Qe4+ Kg8 39.Kg1 Bd5 40.Qf5 Be6 41.Qg5+ Kh7 42.Qe5 Kg6 43.Kh2 Bd5 44.f3 Be6 45.Kg3 Bf5 46.Kh4 Qd7 47.Qg3+ Kh7 48.Kxh5 Qf7+ 49.Kh4 Bg6 50.Qe5 Qg8 51.g4 Bf7 52.Qe7 Qg6 53.Qf8 Bd5 54.Kg3 Bf7 55.Qg7+ Qxg7 56.fxg7 1-0';

var fenString;
//fenString = '8/8/1KP5/3r4/8/8/8/k7 w - 1 0';
//var pgn = '[Event "Saavedra Study"] \n\n 1.c7 Rd6 2.Kb5 Rd5 3.Kb4 Rd4 4.Kb3 Rd3 5.Kc2 Rd4 6.c8R Ra4 7.Kb3 1-0';

chess.ui = {};

var wK = '<img src="img/wk.png" class="piece" />';
var wQ = '<img src="img/wq.png" class="piece" />';
var wR = '<img src="img/wr.png" class="piece" />';
var wB = '<img src="img/wb.png" class="piece" />';
var wN = '<img src="img/wn.png" class="piece" />';
var wP = '<img src="img/wp.png" class="piece" />';

var bK = '<img src="img/bk.png" class="piece" />';
var bQ = '<img src="img/bq.png" class="piece" />';
var bR = '<img src="img/br.png" class="piece" />';
var bB = '<img src="img/bb.png" class="piece" />';
var bN = '<img src="img/bn.png" class="piece" />';
var bP = '<img src="img/bp.png" class="piece" />';

var pieceImage = function(char) {
	switch(char) {
	case 'wK': return wK;
	case 'wQ': return wQ;
	case 'wR': return wR;
	case 'wB': return wB;
	case 'wN': return wN;
	case 'wP': return wP;
	case 'bK': return bK;
	case 'bQ': return bQ;
	case 'bR': return bR;
	case 'bB': return bB;
	case 'bN': return bN;
	case 'bP': return bP;
	default: return null;
	}
};

chess.ui.board = {
	clearBoard: function() {
		$('img').remove();
	},
	updatePosition: function(pos) {
		this.clearBoard();
		for (var rowIndex = 0; rowIndex < chess.board.rowNames.length; rowIndex++) {
			for (var fileIndex = 0; fileIndex < chess.board.fileNames.length; fileIndex++) {
				var file = chess.board.fileNames[fileIndex];
				var row = chess.board.rowNames[rowIndex];
				var square = file + row;
				var piece = pos.pieceOn(square);
				if (piece) {
					var image = pieceImage(piece);
					$('#' + square).append(image);
				}
			}
		}
	},
	nextMove: function() {
		chess.game.nextMove();
		this.updatePosition(chess.game.currentPos);
	},
	previousMove: function() {
		chess.game.previousMove();
		this.updatePosition(chess.game.currentPos);
	},
	timeoutHandle: null,
	// The play after the function keyword makes the function accessible from within, i.e. recursively. Could also be a different name.
	play: function playRec() {
		if (chess.game.endPos.plies - chess.game.currentPos.plies > 0) {
			chess.ui.board.nextMove();
			$('.testDiv').html('ply ' + chess.game.currentPos.plies + '/' + chess.game.endPos.plies);
			timeoutHandle = setTimeout(playRec, 20);
		}
	},
	stop: function() {
		if (timeoutHandle) {
			clearTimeout(timeoutHandle);
			timeoutHandle = null;
		}
	},
	goToMove: function(move, color) {
		chess.game.goToMove(move, color);
		this.updatePosition(chess.game.currentPos);
	}
};

var loadGame = function(pgn) {
	var gameArea = $('#game-area');
	gameArea.val(pgn);
	
	gameArea.select(function() {
		var start = this.selectionStart;
		var end = this.selectionEnd;
		$('.testDiv').html('selected: ' + this.value.substring(start, end));
		
		var move = chess.pgnParser.selectedMove(pgn, start);
		chess.ui.board.goToMove(move.move, move.color);
	});
};

chess.game = new Game(fenString);

$(document).ready(function() {
	$(document).bind('keydown', 'left', function(event) {
		chess.ui.board.previousMove();
	});
	$(document).bind('keydown', 'right', function(event) {
		chess.ui.board.nextMove();
	});
	$(document).bind('keydown', 'down', function(event) {
		chess.ui.board.play();
	});
	$(document).bind('keydown', 'up', function(event) {
		chess.ui.board.stop(); 
	});
	
	var movetext = chess.pgnParser.movetext(pgn);
	var plies = chess.pgnParser.plies(movetext);
	
	for (var i = 0; i < plies.length; i++) {
		var move = chess.pgnParser.parsePly(plies[i], chess.game.endPos);
		chess.game.addMove(move);
	}
	chess.ui.board.updatePosition(chess.game.startPos);

	loadGame(pgn);
});


